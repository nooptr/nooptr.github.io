<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Amazon SQS là gì</title>
	
	<meta name="description" content="Amazon SQS làm được gì và khi nào nên sử dụng nó?
">
	
	<meta name="author" content="nooptr">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/nooptr">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://twitter.com/nooptr">
				<i class="fa fa-twitter"></i>
			</a>
			
			
			<a class="navbar-brand" href="/">
				<img src="//www.gravatar.com/avatar/1dc005df10d27ebd46e4980cd9da0796?s=35" class="img-circle" />
				Tech Blog
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/categories.html">Categories</a></li>
				<li><a href="/tags.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="//www.gravatar.com/avatar/1dc005df10d27ebd46e4980cd9da0796?s=150" class="img-circle" />
	</a>
	<h3 class="title">
        <a href="/">Tech Blog</a>
    </h3>
</header>


<div id="bio" class="text-center">
	Blog chia sẻ những kiến thức về lập trình!
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/nooptr">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://twitter.com/nooptr">
				<i class="fa fa-twitter fa-lg"></i>
			</a>
		</li>
		
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		
		<li>
			<a class="btn btn-default btn-sm" href="/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>Amazon SQS là gì </h1>
</div>
	
<article>

	<div class="col-sm-10">
	 <span class="post-date">
	   
	   March 
	   1st,
	     
	   2017
	 </span>
	  <div class="article_body">
	  <p>Mình cũng đã nghe qua khá nhiều về cái tên SQS (Simple Queue Service) nhưng mà chưa từng lần nào tìm hiểu hẳn hoi tử tế. Hôm nay quyét tâm dành thời gian ra tìm hiểu nó.
Thực ra mình đang định thi chứng chỉ Amazon Web Service mà trong đó thấy nó nói nhiều về SQS quá nên không tìm hiểu sâu không được.
Thôi không nói lan man nữa. Vào vấn đề chính thôi.</p>

<h3 id="sqs-l-g">1. SQS là gì?</h3>

<ul>
  <li><code>Amazon Simple Queue Service</code> là 1 dịch vụ về hàng đợi lưu trữ thông điệp (message) 1 cách nhanh chóng, đáng tin cậy và có khả năng mở rộng cao.</li>
  <li>Và đặc biệt là nó khá rẻ ($0.4 với 1 triệu requests)</li>
</ul>

<h3 id="sqs-lm-c-g">2. SQS làm được gì?</h3>

<ul>
  <li>Với 1 queue, nó có thể gửi, nhận, xoá message.</li>
  <li>Với 1 số tính năng mà không yêu cầu tính realtime thì ta có thể gửi message đến queue và xử lí sau đó thông qua batch.</li>
</ul>

<h3 id="c-th-sqs-c-s-dng-nh-th-no">3. Cụ thể SQS được sử dụng như thế nào?</h3>

<p>Để dễ hiểu bây giờ mình sẽ lấy 1 ví dụ về logic nạp tiền trong game.  Khi đó với trường hợp không sử dụng SQS với trường hợp sử dụng SQS nó khác nhau thế nào?</p>

<h4 id="a-khng-s-dng-sqs">a. Không sử dụng SQS</h4>

<ul>
  <li>Khi người dùng nạp tiền trong game, đa số chúng ta đều viết logic xử lí payment đồng thời với việc ghi log vào trong DB.</li>
  <li>Giả sử như việc ghi log vào DB là 1 việc cần thiết. Vì 1 lí do nào đó mà logic nào đó mà việc ghi log vào trong DB bị lỗi dẫn đến toàn bộ xử lí bị stop lại và đồng thời thông báo tin nhắn ERROR đến người dùng.</li>
</ul>

<h4 id="b-s-dng-sqs">b. Sử dụng SQS</h4>
<ul>
  <li>Khi người dùng tiến hành nạp tiền thì sẽ gửi 1 message ghi log đến SQS và sẽ thực hiện việc xử lí ghi log này về sau thông qua batch.</li>
  <li>Nhờ vào việc xử lí này mà thời gian xử lí toàn bộ logic của hệ thống cũng giảm xuống và nó cũng không gây ảnh hưởng gì đến logic xử lí payment coin.</li>
  <li>Đối với message đang được lưu trên SQS thì sẽ được xử lí thông qua batch từ 1 server khác được chạy định kì.</li>
</ul>

<h3 id="p-dng-thc-t">4. Áp dụng thực tế</h3>

<p>Sau đây mình xin viết 1 đoạn code demo về việc tương tác với SQS như sau:</p>

<p>※ Mình sẽ không hướng dẫn các bạn cài đặt SQS trên AWS nhé. Các bạn có thể tham khảo về việc cài đặt ở link cuối bài.</p>

<p><code>Make a SQS instance</code></p>

<pre><code>function static get_sqs_client()
{
    $client = new SqsClient([
      'version' =&gt; 'latest',
      'region' =&gt; Region::TOKYO
    ]);

    return $client;
}
</code></pre>

<p><code>Send message to SQS</code></p>

<pre><code>public static function send_sqs_message($sqs_name, $data) {
  // Get SQS instance
  $client = self::get_sqs_client();

  // Send message to SQS
  $client-&gt;sendMessage(array(
    'QueueUrl'    =&gt; "https://sqs.ap-northeast-1.amazonaws.com/[QUEUE_ID]/{$sqs_name}",
    'MessageBody' =&gt; json_encode($data),
  ));
}
</code></pre>

<p><code>Receive message from SQS</code></p>

<pre><code>public static function receive_sqs_message() {
  // Get SQS instance
  $client = self::get_sqs_client();

  // Get Queue URL
  $listqueues = $client-&gt;listQueues();
  $queueUrls  = $listqueues['QueueUrls'];

  // Get message from Queue
  foreach ($queueUrls as $queueUrl) {
    $result = $client-&gt;receiveMessage(array(
      'QueueUrl' =&gt; $queueUrl,
      'MaxNumberOfMessages' =&gt; 10,
      'WaitTimeSeconds' =&gt; 20
    ));

    foreach ($result-&gt;getPath('Messages') as $messageBody) {
      $data = json_decode($messageBody);

      // array('user_id' =&gt; '1', 'purchase_date' =&gt; '20140501', 'price' =&gt; '9800');
      $values = $data['values'];

      // TODO Process log to DB
      $target_table = $data['target_table'];
      Model_Logs::insert_log($target_table, $values);

      // Delete message from SQS
      $ReceiptHandle = $messageBody['ReceiptHandle'];
      $client-&gt;deleteMessage([
        'QueueUrl' =&gt; $queueUrl,
        'ReceiptHandle' =&gt; $ReceiptHandle
      ]);
    }
  }
}
</code></pre>

<p>Hi vọng bài viết của mình sẽ giúp ích cho các bạn khi tìm hiểu về SQS.</p>

<h3 id="ngun-tham-kho">Nguồn tham khảo</h3>

<p>AWS SDK for PHP:</p>

<p><a target="_blank" href="http://docs.aws.amazon.com/aws-sdk-php/v3/guide/getting-started/installation.html">http://docs.aws.amazon.com/aws-sdk-php/v3/guide/getting-started/installation.html</a></p>

<p>Guide SQS for AWS SDK PHP:</p>

<p><a target="_blank" href="http://docs.aws.amazon.com/aws-sdk-php/v2/guide/service-sqs.html">http://docs.aws.amazon.com/aws-sdk-php/v2/guide/service-sqs.html</a></p>

	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/categories.html#aws-ref">
					aws <span>(2)</span>
					
				</a></li>
			
		  
		</ul>
		  

		
		<ul class="list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tags.html#sqs-ref">
					sqs <span>(1)</span>
					
					</a>
				</li>
			
		  
		  
		</ul>
		  

		<hr>

		<div>
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=Amazon SQS là gì&via=nooptr"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
      </section>

      <section class="col-sm-6 author">
        <img src="//www.gravatar.com/avatar/1dc005df10d27ebd46e4980cd9da0796" class="img-rounded author-image" />
        <h4 class="section-title author-name">nooptr</h4>
        <p class="author-bio">Blog chia sẻ những kiến thức về lập trình!</p>
      </section>
    </div>

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="/web/2017/02/27/xu-huong-thiet-ke-web-2017.html" title="Xu hướng thiết kế web 2017">&larr; Previous</a></li>
		  
		  
		  <li class="next"><a href="/pattern/2017/04/17/hieu-qua-cua-exponential-backoff-trong-xu-li-error-retries.html" title="Hiệu quả của exponential backoff trong xử lí error retries">Next &rarr;</a></li>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
<div class="clearfix"></div>





		<footer>
			<hr/>
			<p>
				&copy; 2017 nooptr with <a href="">Tech Blog</a>
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>



<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-91740366-1', 'auto');
  ga('send', 'pageview');
</script>

