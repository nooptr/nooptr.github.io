{"componentChunkName":"component---src-templates-post-template-js","path":"/2019/08/03/ginco-da-su-dung-va-toi-uu-cloud-functions-nhu-the-nao","result":{"data":{"markdownRemark":{"id":"e36168ae-73b2-5c81-a37b-e0262bce32f0","html":"<p>Xin chào mọi người. Dạo này ăn hành nhiều quá thành ra không có thời gian viết bài.</p>\n<p>Hôm nay mình chia sẻ đến mọi người 1 case study khá hay mà <a href=\"https://ginco.io/en/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Ginco</a> đã thực hiện để quản lí giao dịch trong Blockchain bằng cách sử dụng hệ sinh thái Firebase.</p>\n<p>Gần đây công ty mình cũng bắt đầu đưa Firebase vào hệ thống. Đúng quả thật dùng Firebase xong thấy yêu nó hẳn. Nó quả thực rất mạnh và cũng khá rẻ. Nên thời gian tới mình sẽ tập trung viết nhiều bài hơn nữa về Firebase để mọi người có cái nhìn tổng quan hơn về nó.</p>\n<p>Bây giờ chúng ta cùng nhau tìm hiểu xem Ginco đã sử dụng Firebase để xử lí các bài toán liên quan đến giao dịch Blockchain như thế nào.</p>\n<p><strong>Mục tiêu bài viết:</strong><br>\n・Hiểu được cách dùng Cloud Functions trong hệ thống<br>\n・Biết cách tối ưu Cloud Functions để đạt hiệu năng tốt nhất</p>\n<p><strong>Đối tượng hướng đến:</strong><br>\n・Người có chút hiểu biết về Cloud Functions<br>\n・Người đã từng làm việc với Firebase</p>\n<h2 id=\"ginco-là-công-ty-như-thế-nào\"><a href=\"#ginco-l%C3%A0-c%C3%B4ng-ty-nh%C6%B0-th%E1%BA%BF-n%C3%A0o\" aria-label=\"ginco là công ty như thế nào permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ginco là công ty như thế nào?</h2>\n<p><a href=\"https://ginco.io/en/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Ginco</a> là công ty Nhật Bản chuyên cung cấp hệ thống quản lí wallet tiền ảo 1 cách an toàn và bảo mật. Nó có thể gửi, nhận tiền ảo 1 cách đơn giản thông qua hệ thống Blockchain.</p>\n<ul>\n<li><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 377px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ab890d2160a04ec8b30ad3fd66b467d0/f6cb0/Screen-Shot-2019-08-03-at-22.29.11.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 164.19098143236076%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAhCAIAAABWXBxEAAAACXBIWXMAAAsSAAALEgHS3X78AAAEiElEQVQ4y3VV+09TVxz3H1sySNQszm2ALSxQ27igCZIAWXzMbC5LhlmyuWzxlzm3ZIb9MJ1DiQrLACVFkAprWV+0tqXSXqCv2/a+73nd7nvuxQqlnpzce8499/N9ne/38z3SsAejjBJKMcUIwySYtEz7lMARMhCsGxZHHeFIxpGOFFggE1HKtxazYMuRlDZ1GJquazosmmCKMNNMvrcsLlPTtJ2dHUmSEEKNg8M0TFVRwcY9sMWYqtPtCt8zG1wqlubm5paXloqFYlNiezAFhzExDF3XDefssMK3ghmlhBCAas5QNdiCn/sVtgc7fwh5YfKvyampqTt/3Fl5/vzxo8cTtyfqtfp+m+EN87DPFuxj0VgykYxGY6mXKVjHonGwpYlpGsHBsgpX8NpnbiNIoo23D8Iaks4MxLCJDoB5hlAq5GtCTi3smoWCWSqZ5ZJZqeDmFLbRqzxCxEL7wdwcquxEg1dG41dGwheHI58OR8/5Imc8kTPe6Ce+uM8bP3c2MTqSvHwh9XBR0TlYIagJJtKmf3rQHTg/EBjyvBjy/us+udpzYs31Yaj7g5CrO9zfF/WejvlOx27erwJYO6hZyvhnxnwvPh9eG78c/upi+PvxxLUv4t9+/fK7a6kB97qra72nK9znivwyVdMA/OaqHPDC9GdnA9evhsYvBb8cC10dXb80FBwbDF0Y+s9zKvhxd6i3Z73fHf75frUNOOufOd+9MNL3dLR/cfAjv7vjad8xf+/xZ6eOLve+F3CfWHWdXPO4Qj/dE1WjBUyk3NITb+ezgXf+8XbO+o7N+44veI76+zqW3R0r7s6AqzPQ9e6K5/3VW5OHwUzaeDR991auJqJMQkrH6zXRnH2wO/+wUC6Yyaic2lDEMnowIfzwW0lDuMVsOetfvPlNcuVJYXZS+PtPIbBQuv1jeuJGenmuOH03P3NPWJov/3o9/fuUeMBnO8MII3gzIUdWxY1QDWZ0TYyHqvFgNbJWjYdqsWAtvFrNbEjwo6GbB8DAJFBGjGFY2kkK02qboZhYh0rSBtvVaOiaoSoa5OAe7zBgCqgry0BWsUZ1xNDhqsKISLKGMYYylGVZkZV6vV6tVkGuU5VAD0B0sAKzWzRbFGvZREKsyK+yWShJKG+oR9M0nWI2KcpK25m6YBCEDdTCJMz5yeYPAvodGnlDAw2LgF7GP7b6DMaAmu2tLUWqZTKb2WxWyOc3M5uCIDh4TElRqZTVKmYEtWiGmCDK6pWiqcnlsihWxEqlUigUwGdi8zliZNcQd4xyGzAnfc6BFGNOgxBq6AyN1xY7T2IShlk79rQazFSKyYQkadnMJhicTqW3BWFrKwe87wQsrxTyahFR3KqZ8t5hVWVL1UGRxfVrOqc1wluXHTfLpNjAJmfPlquC7AKMP0wTOdswE0t1ybFaVVXIH/5RN5yPrWBIEp4npEGo3ahUFe4ZGg3ELJ/LQ8rYCviA30ye2xojzatyrtoWAbExdAN6VblUqpRKsIAGwi/aPgJH4JSHs9li9+LKbBOoLWLfcFo3PPkk/Mll2eN//J4B6Ki0L9AAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/ab890d2160a04ec8b30ad3fd66b467d0/01472/Screen-Shot-2019-08-03-at-22.29.11.webp 240w,\n/static/ab890d2160a04ec8b30ad3fd66b467d0/9de00/Screen-Shot-2019-08-03-at-22.29.11.webp 377w\"\n          sizes=\"(max-width: 377px) 100vw, 377px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/ab890d2160a04ec8b30ad3fd66b467d0/0783d/Screen-Shot-2019-08-03-at-22.29.11.png 240w,\n/static/ab890d2160a04ec8b30ad3fd66b467d0/f6cb0/Screen-Shot-2019-08-03-at-22.29.11.png 377w\"\n          sizes=\"(max-width: 377px) 100vw, 377px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/ab890d2160a04ec8b30ad3fd66b467d0/f6cb0/Screen-Shot-2019-08-03-at-22.29.11.png\"\n          alt=\"Screen Shot 2019 08 03 at 22 29 11\"\n          title=\"Screen Shot 2019 08 03 at 22 29 11\"\n          loading=\"lazy\"\n        />\n      </picture>\n  </a>\n    </span></li>\n</ul>\n<h2 id=\"cloud-functions-là-gì\"><a href=\"#cloud-functions-l%C3%A0-g%C3%AC\" aria-label=\"cloud functions là gì permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cloud Functions là gì?</h2>\n<p>Cloud Functions là 1 sản phẩm của Google.</p>\n<p>Cloud Functions cho phép bạn chạy code backend tự động <strong><a href=\"https://cloud.google.com/functions/docs/concepts/events-triggers\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">trigger các event</a></strong> được kích hoạt bởi tính năng của Firebase (Google).</p>\n<p>Ví dụ như khi chúng ta upload 1 ảnh lên Google Storage thì Cloud Functions sẽ tự động trigger sự kiện đó để xử lí 1 tác vụ nào đó. Ví dụ như resize ảnh chẳng hạn …</p>\n<p><strong>Các lợi ích khi sử dụng Cloud Functions:</strong></p>\n<ul>\n<li>Tạo API 1 cách đơn giản</li>\n<li>Mỗi 1 hàm được deploy đều được chạy trong 1 môi trường hoàn toàn khác nhau. Do đó chức năng của hàm này sẽ không ảnh hưởng đến hàm khác. Và việc thêm sửa xoá chức năng được thực hiện 1 cách khá đơn giản.</li>\n<li>Dựa vào số lượng request mà hệ thống sẽ tự động được scale</li>\n</ul>\n<h2 id=\"ứng-dụng-cloud-functions-trong-ginco\"><a href=\"#%E1%BB%A9ng-d%E1%BB%A5ng-cloud-functions-trong-ginco\" aria-label=\"ứng dụng cloud functions trong ginco permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ứng dụng Cloud Functions trong Ginco</h2>\n<p>Ở Ginco thì Cloud Functions đảm nhiệm 4 chức năng chính:</p>\n<ul>\n<li>Cung cấp API gọi giao thức RPC của Blockchain</li>\n<li>Cung cấp API thu thập thông tin về market (giá cả thị trường, volume …)</li>\n<li>Push Notification</li>\n<li>Thực hiện backup Firestore định kì</li>\n</ul>\n<p>Dưới đây là kiến trúc hệ thống xung quanh Cloud Functions trong Ginco</p>\n<ul>\n<li><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 846px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a7a0bc1d07d17b5fd737000526c2d38c/c5f2c/ginco-architecture.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 68.91252955082743%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAACJklEQVQoz3VTTY/TMBDNL0X8D/7AnhA3bgiJGxXSallWdFdaEKBKq7LblqZN04/QpknTJHbctE5iO3bCpCkFqmWUg8fym3kz70Ur/4kC48j1UJalh7woOOdKqfKx0I6nXEo/K2Pnbtc940UFrC7zHPAnGClloYSSQlP7gKuU5zgry8wy717RNK8fCSHCMIxIjKJ4syEYY0I2nud8eViN7fhP51SoHcuhjLfl0FbuiwJ/XR+sl7P5qDMcGpZlGcbIdeyX7/FtL9N0/cdwoAM4ETLOqoZ2GEuZK1WxlYJ3h1P98nmhv268O3+4/97rdhuNt3PbDUKsXTVvL68/+zsWUg5YxeItcYMgjDACMKXUNMejsUmQ1+0PgfbctifWT0IihJDWnvltG3vRjqTcZ+XWfGOcP+3YieHiJUnnfvS13WkNrP7M+dYb96eLe2M2XTjTsQm70JrNjzc317UqwFQyfzLpUKaYLFAieK4QvAr8IAgQnIBSAHkIOQihLddovgpqcKUNzBzRev9xJrP8cYUPOjNVUAHAAlYky1IkKCFWrSyiLCBbIbhKVgqUrZao3Eh6RNW9NJ7L9ZbhRGCaIV7y5Qe/9aw2SZwJO0rRhkSfniwdE1wAc5xdpC+uKv/BjNoJk5SixXzCmDgOwlJqjVqe51UAmU8W4WJFykId7Fn8/qSSYCawd5Ike3BVbkcTElPG2d+/wKm3/xdHe8MWwU7WbAalQX9w7i/WRxSi+AXY9QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/a7a0bc1d07d17b5fd737000526c2d38c/01472/ginco-architecture.webp 240w,\n/static/a7a0bc1d07d17b5fd737000526c2d38c/222bd/ginco-architecture.webp 480w,\n/static/a7a0bc1d07d17b5fd737000526c2d38c/34963/ginco-architecture.webp 846w\"\n          sizes=\"(max-width: 846px) 100vw, 846px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/a7a0bc1d07d17b5fd737000526c2d38c/0783d/ginco-architecture.png 240w,\n/static/a7a0bc1d07d17b5fd737000526c2d38c/782f4/ginco-architecture.png 480w,\n/static/a7a0bc1d07d17b5fd737000526c2d38c/c5f2c/ginco-architecture.png 846w\"\n          sizes=\"(max-width: 846px) 100vw, 846px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/a7a0bc1d07d17b5fd737000526c2d38c/c5f2c/ginco-architecture.png\"\n          alt=\"ginco architecture\"\n          title=\"ginco architecture\"\n          loading=\"lazy\"\n        />\n      </picture>\n  </a>\n    </span></li>\n</ul>\n<h3 id=\"1-cung-cấp-api-gọi-giao-thức-rpc-của-blockchain\"><a href=\"#1-cung-c%E1%BA%A5p-api-g%E1%BB%8Di-giao-th%E1%BB%A9c-rpc-c%E1%BB%A7a-blockchain\" aria-label=\"1 cung cấp api gọi giao thức rpc của blockchain permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Cung cấp API gọi giao thức RPC của Blockchain</h3>\n<p>Toàn bộ các node blockchain được chạy trên GKE.</p>\n<p>Bởi vì các API trong các node blockchain (ví dụ như bitcoin, ethereum…) này hoàn toàn khác nhau. Nên họ đã cung cấp 1 API đã wrapper lại tất cả các API đó thành chung 1 interface để dễ dàng sử dụng.</p>\n<p>Giai đoạn đầu thì họ đã dùng <a href=\"https://firebase.google.com/docs/functions/http-events\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">HTTP trigger</a>, nhưng cái này có 1 nhược điểm là khi gọi API thì nó không tự động gửi access token của người dùng lên. Nên thành ra mỗi lần gọi API phải tự mình đính kèm access token vào header của request.</p>\n<p>Họ đã dùng <a href=\"https://firebase.google.com/docs/functions/callable\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">onCall trigger</a>. Cái này thì nó tự động đính kèm access token của người dùng vào header. Nên khá dễ dàng để chứng thực người dùng.</p>\n<h3 id=\"2-cung-cấp-api-thu-thập-thông-tin-về-market-giá-cả-thị-trường-volume-\"><a href=\"#2-cung-c%E1%BA%A5p-api-thu-th%E1%BA%ADp-th%C3%B4ng-tin-v%E1%BB%81-market-gi%C3%A1-c%E1%BA%A3-th%E1%BB%8B-tr%C6%B0%E1%BB%9Dng-volume-\" aria-label=\"2 cung cấp api thu thập thông tin về market giá cả thị trường volume  permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Cung cấp API thu thập thông tin về market (giá cả thị trường, volume …)</h3>\n<p>Ginco sử dụng Firestore là cơ sở dữ liệu chính để lưu trữ thông tin về market (giá cả thị trường, volume …)</p>\n<p>Các thao tác CRUD liên quan đến dữ liệu sẽ được thực hiện trực tiếp từ phía Client (sử dụng Firebase SDK)</p>\n<p>Còn 1 số dữ liệu quan trọng cần tính bảo mật cao hơn thì sẽ không gọi trực tiếp từ SDK Firebase phía Client mà sẽ thông qua Cloud Functions. </p>\n<h3 id=\"3-push-notification\"><a href=\"#3-push-notification\" aria-label=\"3 push notification permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Push Notification</h3>\n<p>1 số event liên quan đến lịch sử gửi nhận coin sẽ thực hiện việc gửi thông báo (push notification) đến người dùng.</p>\n<p>Vì Cloud Functions có thể trigger được các <a href=\"https://firebase.google.com/docs/functions/firestore-events\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">sự kiện liên quan đến Firestore</a> nên khi dữ liệu trong Firestore mà bị thay đổi nó sẽ detect được và tiến hành gửi thông báo đến người dùng.</p>\n<h3 id=\"4-thực-hiện-backup-firestore-định-kì\"><a href=\"#4-th%E1%BB%B1c-hi%E1%BB%87n-backup-firestore-%C4%91%E1%BB%8Bnh-k%C3%AC\" aria-label=\"4 thực hiện backup firestore định kì permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. Thực hiện backup Firestore định kì</h3>\n<p>Việc backup Firestore sẽ được thực hiện thông qua Cloud Functions.</p>\n<p>Bằng việc trigger <a href=\"https://firebase.google.com/docs/functions/pubsub-events?\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Cloud Pub/Sub</a>, Cloud functions sẽ dễ dàng backup được dữ liệu của Firestore thông qua <a href=\"https://firebase.google.com/docs/firestore/reference/rest/v1beta1/projects.databases/exportDocuments\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Firestore command line</a>.</p>\n<p>Chúng ta chỉ cần sử dụng cronjob trong App Engine để gửi message đến Pub/Sub. Khi đó Cloud Functions sẽ trigger được event đó và thực hiện backup.</p>\n<h2 id=\"tối-ưu-cloud-functions\"><a href=\"#t%E1%BB%91i-%C6%B0u-cloud-functions\" aria-label=\"tối ưu cloud functions permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tối ưu Cloud Functions</h2>\n<p>Mặc dù Cloud Functions khá là tiện nhưng khi số lượng function tăng lên thì tốc độ response của nó cũng giảm xuống đáng kể (đôi khi mất 13s cho 1 request). </p>\n<p>Ở đây mình sẽ nói qua 1 số vấn đề gặp phải và cách khắc phục nó.</p>\n<h3 id=\"kiến-trúc-cloud-functions\"><a href=\"#ki%E1%BA%BFn-tr%C3%BAc-cloud-functions\" aria-label=\"kiến trúc cloud functions permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Kiến trúc Cloud Functions</h3>\n<p>Cloud Functions được thực hiện như sau:</p>\n<ul>\n<li>1 request sẽ được xử lí bằng 1 instance</li>\n<li>\n<p>Trong trường hợp nhận được request mới:</p>\n<ul>\n<li>Nếu có instance còn trống thì sẽ gửi request đó đến instance trống đó</li>\n<li>Nếu không có instance trống thì sẽ tạo instance mới, và gửi request đến instance đó</li>\n</ul>\n</li>\n<li>Nếu trong 1 khoảng thời gian nào đó mà instance không xử lí request thì instance đó sẽ bị xoá đi.</li>\n</ul>\n<p>Và trường hợp tạo instance mới và xử lí request là tốn thời gian nhất. Trường hợp này người ta gọi là <strong>Cold Start</strong>. (Mặc dù bản thân việc tạo 1 instance mới chỉ mất tầm mấy trăm ms thôi)</p>\n<p>Dưới đây là hình ảnh về hiện tượng Cold Start. Nếu không có instance nào trống thì sẽ tạo ra instance mới để xử lí request.</p>\n<ul>\n<li><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 670px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f8d90b83507ea271afb3f5cf0bdced44/9b1de/coldstart.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.26865671641791%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAAB9ElEQVQoz2P4uZMBDED01+0MDAcO+UMEXPczMWTv5AIxDYtrGf7uZWD4DlX7YydIPTsDTvBzF6ZY8tv/rEL910SJUYuugBFKiwJt3vd7N8PJZ6sZjt9ZxnT2zkr2S0D2CaD4EaD8FaAvoqFqmX/u5MBu4PedLIxQWurbTuaHP3czv3qymuXF1YXsb28u4/l8bQHLy8/bWZ9938Xy+/tOphyIWiYWnF7+29rC8G9aDfN/y/9g/tLpNzmfnD/H+/DGIeH2dUfVazeel5+y7idH6TeI/P89EH08Id0MRprKDCaW1gy6uroMqqqqDJpaWmjhtmgOE1Zba84J8lfvhzjp0H8GzkW/GRkCmxg6musZ+iZMZDA2NmYIDAxkUFFRAdrYXCr8s6s+7nl3k9uXljy2X1214e+6G0NA7vncXe/3rbsu4X9jKgd/8yFFxea9IgyEwL/O2uj/W1f9/z+h7fj/6hyF/6vm//8/pev7vzgPWSD96f+aRf9/Npbqg9ROS0tg5Zn7SY9t6f9wfu884YTIEKXUjCxFfX19YWtra0kNDQ0hhn/t1cb/JrQd+NfbVPmvJlfwX3/rln8TWmf+D7fnAdJT/09o3f69qUySoeY/q37VGh6BaU+F2Jb9l+AMqmGrLM7nq29s4jM0NGTz9PTkUlNTYwUAV1/c2T3gkYgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/f8d90b83507ea271afb3f5cf0bdced44/01472/coldstart.webp 240w,\n/static/f8d90b83507ea271afb3f5cf0bdced44/222bd/coldstart.webp 480w,\n/static/f8d90b83507ea271afb3f5cf0bdced44/5c891/coldstart.webp 670w\"\n          sizes=\"(max-width: 670px) 100vw, 670px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/f8d90b83507ea271afb3f5cf0bdced44/0783d/coldstart.png 240w,\n/static/f8d90b83507ea271afb3f5cf0bdced44/782f4/coldstart.png 480w,\n/static/f8d90b83507ea271afb3f5cf0bdced44/9b1de/coldstart.png 670w\"\n          sizes=\"(max-width: 670px) 100vw, 670px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/f8d90b83507ea271afb3f5cf0bdced44/9b1de/coldstart.png\"\n          alt=\"coldstart\"\n          title=\"coldstart\"\n          loading=\"lazy\"\n        />\n      </picture>\n  </a>\n    </span></li>\n</ul>\n<h3 id=\"cải-thiện-cold-start\"><a href=\"#c%E1%BA%A3i-thi%E1%BB%87n-cold-start\" aria-label=\"cải thiện cold start permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cải thiện Cold Start</h3>\n<h4 id=\"1-cải-thiện-cold-start-của-cloud-functions\"><a href=\"#1-c%E1%BA%A3i-thi%E1%BB%87n-cold-start-c%E1%BB%A7a-cloud-functions\" aria-label=\"1 cải thiện cold start của cloud functions permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Cải thiện Cold Start của Cloud Functions</h4>\n<p>Sau khi tìm hiểu thì họ thấy được, bản thân của việc tạo 1 instance mới hoàn toàn không tốn quá nhiều thời gian (chỉ mất mấy trăm ms). Mà việc tốn nhiều thời gian nhất ở đây là việc load library.</p>\n<p>Giả sử như file index.js của chúng ta có nội dung như sau:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&lt;code&gt;# index.js\n\nexports.Func1 = require(&#39;./funcs/func1&#39;);\nexports.Func2 = require(&#39;./funcs/func2&#39;);&lt;/code&gt;</code></pre></div>\n<p>Nội dung của funcs/func1.js:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&lt;code&gt;# funcs/func1.js\n\nconst functions = require(&#39;firebase-functions&#39;);\nconst admin = require(&#39;firebase-admin&#39;);\nadmin.initializeApp(functions.config().firebase);\nconst db = admin.firestore();\nmodule.exports = functions.https.onRequest((req, res)=&gt;{\n    // ......\n});&lt;/code&gt;</code></pre></div>\n<p>Nội dung của funcs/func2.js:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&lt;code&gt;# funcs/func2.js\n\nconst functions = require(&#39;firebase-functions&#39;)\nconst google = require(&#39;googleapis&#39;);\nconst rp = require(&#39;request-promise&#39;);\nconst projectId = process.env.GCLOUD_PROJECT;\nmodule.exports = functions.storage.bucket(`${projectId}-bucket`)\n                     .object()\n                     .onFinalize((obj)=&gt;{\n    // ......\n});&lt;/code&gt;</code></pre></div>\n<p>Như ví dụ trên ta có thể thấy được, khi index.js được gọi thì func1, func2 cũng được gọi theo. Khi đó chúng ta sẽ mất thêm thời gian để load các thư viện trong func1, func2.</p>\n<p>Và điều này sẽ làm cho thời gian response của chúng ta giảm xuống. Để giải quyết bài toán này thì rất đơn giản. Chỉ cho load những thư viện cần thiết thôi. </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&lt;code&gt;# index.js\n\nif (!process.env.FUNCTION_NAME || process.env.FUNCTION_NAME === &#39;Func1&#39;) {\n    exports.Func1 = require(&#39;./funcs/func1&#39;);\n}\nif (!process.env.FUNCTION_NAME || process.env.FUNCTION_NAME === &#39;Func2&#39;) {\n    exports.Func2 = require(&#39;./funcs/func2&#39;);\n}&lt;/code&gt;</code></pre></div>\n<p>Khi Cloud Functions được gọi thì khi đó biến môi trường FUNCTION<em>NAME sẽ được gán tên của hàm được gọi. Ví dụ như chúng ta muốn gọi func1 thì khi đó giá trị trong FUNCTION</em>NAME sẽ là func1.</p>\n<h4 id=\"2-up-version-của-module-thành-mới-nhất\"><a href=\"#2-up-version-c%E1%BB%A7a-module-th%C3%A0nh-m%E1%BB%9Bi-nh%E1%BA%A5t\" aria-label=\"2 up version của module thành mới nhất permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Up version của module thành mới nhất</h4>\n<p>Cloud Functions sẽ luôn luôn cache module Nodejs lại và chia sẻ đến mọi function trên toàn thế giới. Vì vậy nếu module bạn đang sử dụng có trong cache của Google Cloud Functions thì khi đó sẽ được dùng luôn và không phải mất thời gian load nữa.</p>\n<p>Vì vậy để có thể dùng được cache trong Cloud Functions thì chúng ta cố gắng update mọi module đến phiên bản mới nhất.</p>\n<h4 id=\"3-thay-đổi-region-trong-cloud-functions\"><a href=\"#3-thay-%C4%91%E1%BB%95i-region-trong-cloud-functions\" aria-label=\"3 thay đổi region trong cloud functions permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Thay đổi region trong Cloud Functions</h4>\n<p>Trước kia thì Cloud Functions chỉ support mỗi region ở Mỹ. Nhưng từ tháng 6 năm ngoái nó support thêm 1 số region khác nữa. Nên các bạn cố gắng chọn region nào gần với hệ thống của các bạn nhất.</p>\n<p>Để setting region cho function thì chúng ta làm như sau:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&lt;code&gt;const functions = require(&#39;firebase-functions&#39;);\nmodule.exports = functions.region(&#39;asia-northeast1&#39;)\n .https\n .onRequest((req, res) =&gt; {\n    // ……\n});&lt;/code&gt;</code></pre></div>\n<p>Về danh sách region mà Cloud Functions đang support thì các bạn có thể xem <a href=\"https://cloud.google.com/functions/docs/locations\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">tại đây</a>.</p>\n<h2 id=\"kết-luận\"><a href=\"#k%E1%BA%BFt-lu%E1%BA%ADn\" aria-label=\"kết luận permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Kết luận</h2>\n<p>Qua bài này mình đã giới thiệu cho các bạn về 1 case study mà Ginco đã sử dụng và tối ưu Cloud Functions trong hệ thống của họ như thế nào. Hi vọng nó sẽ giúp ích cho các bạn 1 phần nào đó trong việc cải thiện hiệu năng.</p>\n<p>==============</p>\n<p>Để nhận thông báo khi có bài viết mới nhất thì các bạn có thể like fanpage của mình ở bên dưới nhé:</p>\n<p>→→→ <a href=\"https://www.facebook.com/669339543503374\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Nghệ thuật Coding Fanpage Facebook</a></p>\n<p>Tham khảo:<br>\n<a href=\"https://speakerdeck.com/sota1235/realtime-messaging-with-firebase-number-phpcon2017\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://speakerdeck.com/sota1235/realtime-messaging-with-firebase-number-phpcon2017</a></p>","fields":{"slug":"2019/08/03/ginco-da-su-dung-va-toi-uu-cloud-functions-nhu-the-nao","tagSlugs":["/tag/cloud-functions/","/tag/cold-start/","/tag/firebase/"]},"frontmatter":{"date":"2019-08-03T14:55:30.000Z","description":"Hôm nay mình chia sẻ đến mọi người 1 case study khá hay mà Ginco đã thực hiện để quản lí giao dịch trong Blockchain bằng cách sử dụng hệ sinh thái Firebase.","tags":["cloud functions","cold start","firebase"],"title":"Ginco đã sử dụng và tối ưu Cloud Functions như thế nào","socialImage":"/media/ginco-architecture.png"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"2019/08/03/ginco-da-su-dung-va-toi-uu-cloud-functions-nhu-the-nao"}}}