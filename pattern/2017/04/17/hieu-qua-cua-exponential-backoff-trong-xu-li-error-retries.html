<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Hiệu quả của exponential backoff trong xử lí error retries</title>
	
	<meta name="description" content="Exponential Backoff là gì và nó đã có hiệu quả như nào trong xử lí error?
">
	
	<meta name="author" content="nooptr">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/nooptr">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://twitter.com/nooptr">
				<i class="fa fa-twitter"></i>
			</a>
			
			
			<a class="navbar-brand" href="/">
				<img src="//www.gravatar.com/avatar/1dc005df10d27ebd46e4980cd9da0796?s=35" class="img-circle" />
				Tech Blog
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/categories.html">Categories</a></li>
				<li><a href="/tags.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="//www.gravatar.com/avatar/1dc005df10d27ebd46e4980cd9da0796?s=150" class="img-circle" />
	</a>
	<h3 class="title">
        <a href="/">Tech Blog</a>
    </h3>
</header>


<div id="bio" class="text-center">
	Blog chia sẻ những kiến thức về lập trình!
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/nooptr">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://twitter.com/nooptr">
				<i class="fa fa-twitter fa-lg"></i>
			</a>
		</li>
		
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		
		<li>
			<a class="btn btn-default btn-sm" href="/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>Hiệu quả của exponential backoff trong xử lí error retries </h1>
</div>
	
<article>

	<div class="col-sm-10">
	 <span class="post-date">
	   
	   April 
	   17th,
	   
	   2017
	 </span>
	  <div class="article_body">
	  <h2 id="li-m-u">Lời mở đầu</h2>
<p>Khi làm việc với API chắc hẳn ai cũng không lạ lẫm gì với các vấn đề liên quan đến gửi nhận dữ liệu như: đang gửi thì server bị lỗi đến đến gửi thất bại, rồi thì rõ ràng khi thất bại mình đã retries lại mấy lần rồi mà sao vẫn bị lỗi …. vân vân và vân vân …</p>

<p>Một trong những kĩ thuật khá đơn giản để giải quyết vấn đề này là thực hiện 1 logic retries request đó.
Logic retries mà đa số chúng ta viết thì đều như sau:</p>

<pre><code>retries = 0

DO
    wait 1 second

    status = Get the result of response

    IF status = SUCCESS
        retry = false
    ELSE
        retry = true
    END IF

    retries = retries + 1

WHILE (retry AND (retries &lt; MAX_RETRIES))
</code></pre>

<p>Nhìn thuật toán bên trên dường như <code>quá perfect???</code> nhưng mà khi suy nghĩ kĩ hơn thì nó thật sự không hiểu quả trong 1 số trường hợp.
Vậy chúng ta hãy cùng đi xem nó là gì nhé.</p>

<p>OK. Let’s Go.</p>

<h2 id="exponential-backoff-l-g">Exponential Backoff là gì?</h2>
<ul>
  <li><code>Exponential Backoff</code> là 1 thuật toán tính toán thời gian đợi giữa mỗi lần retries theo hàm luỹ kế để việc thực hiện gửi lại request được hiệu quả nhất.</li>
</ul>

<p>Ví dụ như lần retries thứ 1 sẽ đợi 1s, lần retries thứ 2 sẽ đợi 2s, lần thứ 3 sẽ đợi 4s …. Tức là chúng ta sẽ làm thời gian đợi sau mỗi lần retries kéo dài ra mà không fix cứng thời gian wait như trước nữa và theo thống kê thì làm như này sẽ rất hiệu quả.</p>

<h2 id="vn--g-nu-khng-dng-exponential-backoff">Vấn đề gì nếu không dùng Exponential Backoff?</h2>

<p>Vậy với thuật toán ở bên trên chúng ta thấy nó đang gặp vấn đề gì?</p>

<ul>
  <li>Giả sử như lần đầu tiên chúng ta có N client đồng thời gửi request. Cả N request này đều gửi thất bại và yêu cầu retries lại. 
Như chúng ta thấy bên trên thì sau 1s cả N client này đều gửi lại request đó. Hãy tưởng tượng server lúc đó đang trong trạng thái quá tải. 
Nếu N client lại gửi request đồng thời sau 1s thì chẳng phải điều này là rất tệ đúng không ak? Server không thể nào handle được tất cả các request đó được.</li>
</ul>

<p>Nếu thời gian gửi lại của các client này mà khác nhau đi thì có lẽ hiệu quả sẽ cao hơn. 
Chính vì lí do này mà <code>Exponential Backoff</code> đã ra đời.</p>

<h2 id="ci-t-thut-ton-exponential-backoff">Cài đặt thuật toán Exponential Backoff</h2>

<pre><code>retries = 0

DO
    wait for random from 0 to (2^retries * 100) milliseconds

    status = Get the result of response

    IF status = SUCCESS
        retry = false
    ELSE
        retry = true
    END IF

    retries = retries + 1

WHILE (retry AND (retries &lt; MAX_RETRIES))
</code></pre>

<p>Với cài đặt trên thì chúng ta có thể thấy. Nếu request của N client đều thất bại và yêu cầu retries thì lúc này sẽ retries như sau.
Client 1 sẽ đợi 1 khoảng thời gian là 1 số random từ 0 ~ (2^retries * 100) ms
Client 2 sẽ đợi 1 khoảng thời gian là 1 số random từ 0 ~ (2^retries * 100) ms
…</p>

<p>Cứ như thế thì khoảng thời gian mà mỗi client này gửi request lại phía server sẽ khác nhau đi. Nhờ việc tránh gửi đồng thời này dẫn đến hiệu quả cao hơn.</p>

<h2 id="v-d-thc-t">Ví dụ thực tế</h2>

<p>Bây giờ hãy thử xem các ông trùm lớn như Google, Amazon … đã thực thi nó như thế nào nhé.</p>

<h4 id="google-http-client">1. Google HTTP client</h4>

<pre><code>retry_interval = retry_interval * multiplier ^ (N - 1)
randomized_interval := retry_interval * (random value in range [1 - randomization_factor, 1 + randomization_factor])
</code></pre>

<ul>
  <li>Nếu status code của response là 500 hoặc 503 thì sẽ tiến hành retries.</li>
  <li>Giá trị default của <code>retry_interval = 0.5s</code>, <code>randomization_factor = 0.5</code>, <code>multiplier = 1.5</code>, <code>max_interval = 1 minute</code>, <code>max_elapsed_time = 15s</code></li>
  <li>Nếu <code>retry_interval &gt; max_elapsed_time (15s)</code> thì stop retries (mặc định là 10 lần)</li>
</ul>

<pre><code>request retry_interval randomized_interval
01      00.50          [0.25, 0.75]
02      00.75          [0.38, 1.12]
03      01.12          [0.56, 1.69]
04      01.69          [0.84, 2.53]
05      02.53          [1.27, 3.80]
06      03.80          [1.90, 5.70]
07      05.70          [2.85, 8.54]
08      08.54          [4.27, 12.81]
09      12.81          [6.41, 19.22]
10      19.22          STOP
</code></pre>

<h4 id="aws-simpledb">2. AWS SimpleDB</h4>

<pre><code>currentRetry = 0
 DO
   status = execute Amazon SimpleDB request
   IF status = success OR status = client error (4xx)
     set retry to false
     process the response or client error as appropriate
   ELSE
     set retry to true
     currentRetry = currentRetry + 1
     wait for a random delay between 0 and (4^currentRetry * 100) milliseconds
   END-IF
 WHILE (retry = true AND currentRetry &lt; MaxNumberOfRetries) 
</code></pre>

<pre><code>Kết quả:

request randomized_interval
1       [0, 400)
2       [0, 1600)
3       [0, 6400)
4       [0, 25600)
5       [0, 102400)
</code></pre>

<h2 id="kt-lun">Kết luận</h2>

<p>Qua bài giới thiệu của mình hẳn các bạn cũng có cái nhìn khác về thuật toán retries rồi đúng không ak?
Vậy còn chần chừ gì nữa, hãy sửa lại thuật toán để trở thành những pro nào.</p>

<h3 id="ngun-tham-kho">Nguồn tham khảo</h3>

<p>Error Retries and Exponential Backoff in AWS:</p>

<p><a target="_blank" href="https://docs.aws.amazon.com/general/latest/gr/api-retries.html">https://docs.aws.amazon.com/general/latest/gr/api-retries.html</a></p>

<p>Exponential Backoff And Jitter:</p>

<p><a target="_blank" href="https://www.awsarchitectureblog.com/2015/03/backoff.html">https://www.awsarchitectureblog.com/2015/03/backoff.html</a></p>

<p>Building for Performance and Reliability with Amazon SimpleDB:</p>

<p><a target="_blank" href="https://aws.amazon.com/articles/Amazon-SimpleDB/1394">https://aws.amazon.com/articles/Amazon-SimpleDB/1394</a></p>


	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/categories.html#pattern-ref">
					pattern <span>(1)</span>
					
				</a></li>
			
		  
		</ul>
		  

		
		<ul class="list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tags.html#exponential backoff-ref">
					exponential backoff <span>(1)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#error retries-ref">
					error retries <span>(1)</span>
					
					</a>
				</li>
			
		  
		  
		</ul>
		  

		<hr>

		<div>
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=Hiệu quả của exponential backoff trong xử lí error retries&via=nooptr"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
      </section>

      <section class="col-sm-6 author">
        <img src="//www.gravatar.com/avatar/1dc005df10d27ebd46e4980cd9da0796" class="img-rounded author-image" />
        <h4 class="section-title author-name">nooptr</h4>
        <p class="author-bio">Blog chia sẻ những kiến thức về lập trình!</p>
      </section>
    </div>

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="/aws/2017/03/01/amazon-sqs-la-gi.html" title="Amazon SQS là gì">&larr; Previous</a></li>
		  
		  
			<li class="next disabled"><a>Next &rarr;</a>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
<div class="clearfix"></div>





		<footer>
			<hr/>
			<p>
				&copy; 2017 nooptr with <a href="">Tech Blog</a>
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>



<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-91740366-1', 'auto');
  ga('send', 'pageview');
</script>

